# MinnowVPN Docker Deployment

Production-ready Docker deployment for MinnowVPN Server with automatic HTTPS, monitoring, and security hardening.

## Features

- **All-in-one deployment**: PostgreSQL, Redis, API server, web console, VPN daemon
- **Automatic HTTPS**: Let's Encrypt certificates via Caddy
- **Security hardened**: Fail2ban brute-force protection, Docker secrets
- **Auto-updates**: Watchtower for automatic container updates
- **Monitoring stack**: Optional Prometheus + Grafana
- **Multi-architecture**: Supports both AMD64 and ARM64

## Quick Start

```bash
# Clone the repository
git clone https://github.com/yourorg/minnowvpn.git
cd minnowvpn/installer/docker

# Run the setup wizard
./scripts/setup.sh
```

The setup wizard will:
1. Prompt for your domain, email, and server IP
2. Generate secure random secrets
3. Build and start all containers
4. Wait for services to become healthy

## Requirements

- Docker Engine 20.10+
- Docker Compose 2.0+
- A domain name pointing to your server
- Ports 80, 443 (TCP) and 51820 (UDP) open

## Architecture

```
Internet
    │
    ├─── TCP 80/443 ───► Caddy (HTTPS) ───► Dart API Server
    │                         │
    │                         └───────────► Flutter Console
    │
    └─── UDP 51820 ────► Rust VPN Daemon
```

### Services

| Service | Description | Port |
|---------|-------------|------|
| `postgres` | PostgreSQL 15 database | 5432 (internal) |
| `redis` | Redis 7 cache & pub/sub | 6379 (internal) |
| `dart-server` | REST API server | 8080 (internal) |
| `flutter-console` | Web management console | 80 (internal) |
| `vpn-daemon` | WireGuard VPN server | UDP 51820, TCP 51821 |
| `caddy` | Reverse proxy + HTTPS | 80, 443 |
| `watchtower` | Auto-updates | - |
| `fail2ban` | Brute-force protection | - |

### Monitoring Stack (Optional)

Enable with `--profile monitoring`:

| Service | Description | Port |
|---------|-------------|------|
| `prometheus` | Metrics collection | 9090 (internal) |
| `grafana` | Dashboards | 3000 (internal) |
| `node-exporter` | Host metrics | 9100 (internal) |
| `redis-exporter` | Redis metrics | 9121 (internal) |
| `postgres-exporter` | PostgreSQL metrics | 9187 (internal) |

## Configuration

### Environment Variables

Copy `.env.example` to `.env` and customize:

```bash
# Required
DOMAIN=vpn.example.com
ACME_EMAIL=admin@example.com
VPN_PUBLIC_IP=1.2.3.4

# Optional
HTTP_PORT=80
HTTPS_PORT=443
VPN_UDP_PORT=51820
GRAFANA_DOMAIN=grafana.example.com
TZ=UTC
```

### Secrets

Secrets are stored in `secrets/` directory (auto-generated by setup.sh):

```
secrets/
├── db_password.txt         # PostgreSQL password
├── redis_password.txt      # Redis password
├── jwt_secret.txt          # JWT signing key
├── encryption_key.txt      # AES-256 encryption key
└── grafana_admin_password.txt  # Grafana admin password
```

**Never commit secrets to version control!**

## Commands

### Basic Operations

```bash
# Start services
docker compose up -d

# Start with monitoring
docker compose --profile monitoring up -d

# View logs
docker compose logs -f
docker compose logs -f dart-server  # Specific service

# Check status
docker compose ps

# Stop services
docker compose down

# Rebuild after code changes
docker compose build --no-cache
docker compose up -d
```

### Backup & Restore

```bash
# Create backup
./scripts/backup.sh

# Create backup to custom location
./scripts/backup.sh /path/to/backups

# Restore from backup
./scripts/restore.sh ./backups/minnowvpn_20240101_120000
./scripts/restore.sh ./backups/minnowvpn_20240101_120000.tar.gz
```

### Maintenance

```bash
# View Fail2ban status
docker compose logs fail2ban

# Unban an IP
docker compose exec fail2ban fail2ban-client set minnowvpn-auth unbanip 1.2.3.4

# Force Watchtower update check
docker compose exec watchtower /watchtower --run-once

# Reload Caddy config
docker compose exec caddy caddy reload --config /etc/caddy/Caddyfile
```

## Security

### Fail2ban Protection

The following jails are configured:

| Jail | Trigger | Ban Time |
|------|---------|----------|
| `minnowvpn-auth` | 5 failed logins in 5 min | 1 hour |
| `minnowvpn-enrollment` | 10 failed enrollments in 1 min | 30 min |
| `minnowvpn-api` | 20 API errors in 1 min | 15 min |

### Security Headers

Caddy adds these headers to all responses:

- `Strict-Transport-Security` (HSTS)
- `X-Content-Type-Options`
- `X-Frame-Options`
- `Content-Security-Policy`
- `Permissions-Policy`

### Network Isolation

- Only Caddy is exposed to the internet
- All internal services communicate via Docker network
- VPN daemon uses host networking for TUN access

## Troubleshooting

### Services not starting

```bash
# Check logs
docker compose logs dart-server
docker compose logs postgres

# Check health status
docker compose ps

# Restart a specific service
docker compose restart dart-server
```

### Certificate issues

```bash
# Check Caddy logs
docker compose logs caddy

# Force certificate renewal
docker compose exec caddy caddy reload --config /etc/caddy/Caddyfile
```

### Database connection issues

```bash
# Check PostgreSQL is healthy
docker compose exec postgres pg_isready -U minnowvpn

# Check database logs
docker compose logs postgres
```

### VPN connection issues

```bash
# Check VPN daemon status
curl http://localhost:51821/api/v1/status

# Check VPN logs
docker compose logs vpn-daemon

# Verify UDP port is open
nc -zvu your-server-ip 51820
```

## Upgrading

### Standard Upgrade

Watchtower automatically updates containers daily at 4am UTC.

### Manual Upgrade

```bash
# Pull latest images
docker compose pull

# Rebuild custom images
docker compose build --no-cache

# Restart with new images
docker compose up -d
```

### Major Version Upgrade

1. Create a backup first
2. Check the changelog for breaking changes
3. Update configuration if needed
4. Run the upgrade

```bash
./scripts/backup.sh
git pull
docker compose down
docker compose build --no-cache
docker compose up -d
```

## Development

### Local Development

```bash
# Use docker-compose.override.yml for local settings
cat > docker-compose.override.yml << EOF
version: "3.9"
services:
  caddy:
    ports:
      - "8080:80"
      - "8443:443"
EOF

docker compose up -d
```

### Building Single Architecture

```bash
# AMD64 only
docker compose build --build-arg TARGETPLATFORM=linux/amd64

# ARM64 only
docker compose build --build-arg TARGETPLATFORM=linux/arm64
```

## License

See the main project LICENSE file.
