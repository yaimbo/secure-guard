# =============================================================================
# Fail2ban Filter: SecureGuard API Abuse
# =============================================================================
#
# Detects general API abuse patterns (too many 4xx errors).
# Matches Caddy JSON access log format.
#
# Triggers:
# - Repeated 4xx responses on any /api/* endpoint
#
# =============================================================================

[Definition]

# Match any 4xx error on API endpoints
failregex = ^.*"remote_ip"\s*:\s*"<HOST>".*"status"\s*:\s*4[0-9][0-9].*"/api/.*$
            ^.*"remote_ip"\s*:\s*"<HOST>".*"uri"\s*:\s*"/api/.*"status"\s*:\s*4[0-9][0-9].*$

# Ignore successful requests and specific paths handled by other filters
ignoreregex = ^.*"status"\s*:\s*2\d\d.*$
              ^.*"/api/v1/auth/login".*$
              ^.*"/api/v1/enrollment/redeem".*$

# Date pattern for Caddy JSON timestamp
datepattern = "ts"\s*:\s*{EPOCH}
