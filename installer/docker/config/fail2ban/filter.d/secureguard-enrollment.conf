# =============================================================================
# Fail2ban Filter: SecureGuard Enrollment
# =============================================================================
#
# Detects failed enrollment code redemption attempts.
# Matches Caddy JSON access log format.
#
# Triggers:
# - 400/401/403/429 responses on /api/v1/enrollment/redeem
#
# =============================================================================

[Definition]

# Match failed enrollment attempts
# These typically return 400 (bad request), 401 (invalid code), 403 (expired), or 429 (rate limited)
failregex = ^.*"remote_ip"\s*:\s*"<HOST>".*"status"\s*:\s*40[0-9].*"/api/v1/enrollment/redeem".*$
            ^.*"remote_ip"\s*:\s*"<HOST>".*"uri"\s*:\s*"/api/v1/enrollment/redeem".*"status"\s*:\s*40[0-9].*$
            ^.*"remote_ip"\s*:\s*"<HOST>".*"status"\s*:\s*429.*"/api/v1/enrollment/.*$
            ^.*"remote_ip"\s*:\s*"<HOST>".*"uri"\s*:\s*"/api/v1/enrollment/.*"status"\s*:\s*429.*$

# Ignore successful requests
ignoreregex = ^.*"status"\s*:\s*2\d\d.*$

# Date pattern for Caddy JSON timestamp
datepattern = "ts"\s*:\s*{EPOCH}
