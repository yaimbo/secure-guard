#!/bin/bash
# SecureGuard VPN Service - Preinstall Script
# Runs before package installation to validate environment and stop existing service

set -e

SERVICE_NAME="com.secureguard.vpn-service"
MIN_MACOS_VERSION="10.15"

# Log to installer log
log() {
    echo "[SecureGuard Preinstall] $1"
}

# Check macOS version
check_macos_version() {
    local current_version
    current_version=$(sw_vers -productVersion)

    if [[ "$(printf '%s\n' "$MIN_MACOS_VERSION" "$current_version" | sort -V | head -n1)" != "$MIN_MACOS_VERSION" ]]; then
        log "ERROR: macOS $MIN_MACOS_VERSION or higher is required (found $current_version)"
        exit 1
    fi
    log "macOS version check passed: $current_version"
}

# Stop existing service if running
stop_existing_service() {
    if launchctl list 2>/dev/null | grep -q "$SERVICE_NAME"; then
        log "Stopping existing SecureGuard service..."
        launchctl bootout system/"$SERVICE_NAME" 2>/dev/null || \
        launchctl unload "/Library/LaunchDaemons/$SERVICE_NAME.plist" 2>/dev/null || true
        sleep 2
        log "Existing service stopped"
    else
        log "No existing service found"
    fi
}

# Main
log "Starting preinstall checks..."
check_macos_version
stop_existing_service
log "Preinstall checks completed successfully"

exit 0
