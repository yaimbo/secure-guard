#!/bin/bash
# SecureGuard VPN Service - Preinstall Script
# Runs before package installation to validate environment and stop existing service

set -e

SERVICE_NAME="com.secureguard.vpn-service"
MIN_MACOS_VERSION="10.15"

# Log to installer log
log() {
    echo "[MinnowVPN Preinstall] $1"
}

# Check macOS version
check_macos_version() {
    local current_version
    current_version=$(sw_vers -productVersion)

    if [[ "$(printf '%s\n' "$MIN_MACOS_VERSION" "$current_version" | sort -V | head -n1)" != "$MIN_MACOS_VERSION" ]]; then
        log "ERROR: macOS $MIN_MACOS_VERSION or higher is required (found $current_version)"
        exit 1
    fi
    log "macOS version check passed: $current_version"
}

# Stop existing service if running
stop_existing_service() {
    log "Checking for existing MinnowVPN service..."

    # Try to stop via launchctl (both user and system level)
    if sudo launchctl list 2>/dev/null | grep -q "$SERVICE_NAME"; then
        log "Stopping existing MinnowVPN service..."
        launchctl bootout system/"$SERVICE_NAME" 2>/dev/null || true
        launchctl unload "/Library/LaunchDaemons/$SERVICE_NAME.plist" 2>/dev/null || true
        sleep 1
    fi

    # Kill any lingering processes
    pkill -9 -f "secureguard-service" 2>/dev/null || true
    pkill -9 -f "secureguard-poc" 2>/dev/null || true

    # Wait for processes to die and ports to be released
    sleep 2

    log "Existing service cleanup completed"
}

# Clean up old files so daemon creates fresh ones with correct permissions
cleanup_old_files() {
    log "Cleaning up old files..."

    # Remove old token file (daemon will create new one with correct permissions)
    if [ -f "/var/run/secureguard/auth-token" ]; then
        rm -f "/var/run/secureguard/auth-token"
        log "Removed old auth token"
    fi

    # Remove old connection state file on upgrade (ensures clean state)
    # After upgrade, daemon starts disconnected until user connects again
    if [ -f "/var/lib/secureguard/connection-state.json" ]; then
        rm -f "/var/lib/secureguard/connection-state.json"
        log "Removed old connection state file (clean upgrade)"
    fi

    log "Cleanup completed"
}

# Main
log "Starting preinstall checks..."
check_macos_version
stop_existing_service
cleanup_old_files
log "Preinstall checks completed successfully"

exit 0
