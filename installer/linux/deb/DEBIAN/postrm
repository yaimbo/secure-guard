#!/bin/bash
# SecureGuard VPN - Post-removal script
# Cleans up directories and configuration after package removal

set -e

SERVICE_NAME="secureguard"
SECUREGUARD_GROUP="secureguard"
DATA_DIR="/var/lib/secureguard"
RUN_DIR="/var/run/secureguard"
LOG_DIR="/var/log/secureguard"

case "$1" in
    purge)
        echo "MinnowVPN: Purging configuration and data..."

        # Remove data directory
        if [ -d "$DATA_DIR" ]; then
            echo "Removing data directory..."
            rm -rf "$DATA_DIR"
        fi

        # Remove log directory
        if [ -d "$LOG_DIR" ]; then
            echo "Removing log directory..."
            rm -rf "$LOG_DIR"
        fi

        # Remove runtime directory
        if [ -d "$RUN_DIR" ]; then
            echo "Removing runtime directory..."
            rm -rf "$RUN_DIR"
        fi

        # Remove group if empty (no users left in it)
        if getent group "$SECUREGUARD_GROUP" > /dev/null 2>&1; then
            # Check if any users are still in the group
            local group_members
            group_members=$(getent group "$SECUREGUARD_GROUP" | cut -d: -f4)
            if [ -z "$group_members" ]; then
                echo "Removing $SECUREGUARD_GROUP group..."
                groupdel "$SECUREGUARD_GROUP" 2>/dev/null || true
            else
                echo "Group $SECUREGUARD_GROUP still has members, keeping it."
            fi
        fi

        echo "Purge complete."
        ;;

    remove|upgrade|failed-upgrade|abort-install|abort-upgrade|disappear)
        echo "MinnowVPN: Cleaning up..."

        # Remove runtime directory (always safe to remove)
        if [ -d "$RUN_DIR" ]; then
            rm -rf "$RUN_DIR"
        fi

        # Reload systemd
        systemctl daemon-reload 2>/dev/null || true

        # Update desktop database
        if command -v update-desktop-database &>/dev/null; then
            update-desktop-database /usr/share/applications 2>/dev/null || true
        fi

        # Update icon cache
        if command -v gtk-update-icon-cache &>/dev/null; then
            gtk-update-icon-cache -f -t /usr/share/icons/hicolor 2>/dev/null || true
        fi

        echo "Cleanup complete."
        ;;

    *)
        echo "Unknown postrm argument: $1"
        ;;
esac

exit 0
