# =============================================================================
# Fail2ban Filter: MinnowVPN Authentication
# =============================================================================
#
# Detects failed authentication attempts on the MinnowVPN API.
# Matches Caddy JSON access log format.
#
# Triggers:
# - 401 responses on /api/v1/auth/login
# - 403 responses on any /api/v1/auth/* endpoint
#
# =============================================================================

[Definition]

# Caddy JSON log format - match failed login attempts
# Example log line:
# {"level":"info","ts":1234567890.123,"logger":"http.log.access","msg":"handled request","request":{"remote_ip":"1.2.3.4",...},"status":401,"uri":"/api/v1/auth/login",...}

# Match 401 on login endpoint
failregex = ^.*"remote_ip"\s*:\s*"<HOST>".*"status"\s*:\s*401.*"/api/v1/auth/login".*$
            ^.*"remote_ip"\s*:\s*"<HOST>".*"uri"\s*:\s*"/api/v1/auth/login".*"status"\s*:\s*401.*$
            ^.*"remote_ip"\s*:\s*"<HOST>".*"status"\s*:\s*403.*"/api/v1/auth/.*$
            ^.*"remote_ip"\s*:\s*"<HOST>".*"uri"\s*:\s*"/api/v1/auth/.*"status"\s*:\s*403.*$

# Ignore successful requests
ignoreregex = ^.*"status"\s*:\s*2\d\d.*$

# Date pattern for Caddy JSON timestamp
datepattern = "ts"\s*:\s*{EPOCH}
